@page "/text-style"
@rendermode InteractiveServer
@using DailyDeBugle.Models
@using DailyDebugle.Services
@inject StyleService StyleService

<PageTitle>Daily Debugle - Редактор текста</PageTitle>

<div class="text-style-container">
    <!-- Панель настроек -->
    <div class="settings-panel">
        <h3 class="panel-title">Типографика</h3>
        
        <!-- Шрифты -->
        <div class="setting-group">
            <h5>Шрифты:</h5>
            
            <div class="form-field">
                <label>Основной шрифт:</label>
                <select @bind="currentStyle.PrimaryFont" class="form-select">
                    <option value="Times New Roman">Times New Roman</option>
                    <option value="Arial">Arial</option>
                    <option value="Georgia">Georgia</option>
                    <option value="Verdana">Verdana</option>
                    <option value="Courier New">Courier New</option>
                </select>
            </div>
            
            <div class="form-field">
                <label>Заголовки:</label>
                <select @bind="currentStyle.HeadingFont" class="form-select">
                    <option value="Times New Roman">Times New Roman</option>
                    <option value="Arial">Arial</option>
                    <option value="Georgia">Georgia</option>
                    <option value="Verdana">Verdana</option>
                    <option value="Courier New">Courier New</option>
                </select>
            </div>
        </div>

        <!-- Размеры текста -->
        <div class="setting-group">
            <h5>Размеры текста (pt):</h5>
            
            <div class="form-field">
                <label>Заголовок H1:</label>
                <input type="number" @bind="currentStyle.H1Size" class="form-control" min="8" max="72" />
            </div>
            
            <div class="form-field">
                <label>Заголовок H2:</label>
                <input type="number" @bind="currentStyle.H2Size" class="form-control" min="8" max="72" />
            </div>
            
            <div class="form-field">
                <label>Основной текст:</label>
                <input type="number" @bind="currentStyle.BodySize" class="form-control" min="8" max="72" />
            </div>
        </div>

        <!-- Междустрочные интервалы -->
        <div class="setting-group">
            <h5>Междустрочные интервалы:</h5>
            
            <div class="form-field">
                <label>Основной текст:</label>
                <input type="number" @bind="currentStyle.BodyLineSpacing" step="0.1" class="form-control" min="1.0" max="3.0" />
            </div>
            
            <div class="form-field">
                <label>Заголовки:</label>
                <input type="number" @bind="currentStyle.HeadingLineSpacing" step="0.1" class="form-control" min="1.0" max="3.0" />
            </div>
        </div>

        <!-- Колонки -->
        <div class="setting-group">
            <h5>Колонки</h5>
            
            <div class="form-field">
                <label>Количество колонок:</label>
                <div class="column-buttons">
                    @foreach (var col in new[] { 1, 2, 3, 4 })
                    {
                        <button class="column-btn @(currentStyle.ColumnCount == col ? "active" : "")"
                                @onclick="() => currentStyle.ColumnCount = col">
                            @col
                        </button>
                    }
                </div>
            </div>
            
            <div class="form-field">
                <label>Расстояние между колонками (см):</label>
                <input type="number" @bind="currentStyle.ColumnGap" step="0.1" class="form-control" min="0.1" max="5.0" />
            </div>
            
            <div class="form-field">
                <label>Ширина колонки (см):</label>
                <input type="number" @bind="currentStyle.ColumnWidth" step="0.1" class="form-control" min="1.0" max="20.0" />
            </div>
        </div>

        <!-- Кнопки управления -->
        <div class="action-buttons">
            <button class="btn btn-secondary" @onclick="ResetToDefault">
                Сбросить
            </button>
            <button class="btn btn-primary" @onclick="SaveSettings">
                Сохранить
            </button>
        </div>
    </div>

    <!-- Панель редактора и предпросмотра -->
    <div class="editor-preview-panel">
        <h4>Редактор текста</h4>
        
        <!-- Редактор текста -->
        <div class="text-editor">
            <div class="editor-toolbar">
                <button class="btn btn-sm btn-outline-secondary" @onclick="InsertHeading">
                    Добавить заголовок
                </button>
                <button class="btn btn-sm btn-outline-secondary" @onclick="ClearText">
                    Очистить
                </button>
            </div>
            
            <textarea @bind="articleText" class="form-control editor-textarea" 
                     placeholder="Начните писать ваш текст здесь..."></textarea>
            
            <div class="editor-info">
                <small>Символов: @articleText.Length | Слов: @WordCount</small>
            </div>
        </div>

        <!-- Предпросмотр -->
        <div class="preview-section">
            <h5>Предпросмотр:</h5>
            
            <div class="current-settings">
                <small>Текущие настройки: 
                    Шрифт: @currentStyle.PrimaryFont, 
                    H1: @currentStyle.H1Size pt, 
                    Колонки: @currentStyle.ColumnCount
                </small>
            </div>
            
            <div class="preview-content" style="@GetPreviewStyle()">
                @if (string.IsNullOrEmpty(articleText))
                {
                    <p style="color: #999; font-style: italic;">Текст для предпросмотра появится здесь...</p>
                }
                else
                {
                    @foreach (var paragraph in GetFormattedText())
                    {
                        if (paragraph.StartsWith("# "))
                        {
                            <h1 style="@GetH1Style()">@paragraph.Substring(2)</h1>
                        }
                        else if (paragraph.StartsWith("## "))
                        {
                            <h2 style="@GetH2Style()">@paragraph.Substring(3)</h2>
                        }
                        else
                        {
                            <p style="@GetParagraphStyle()">@paragraph</p>
                        }
                    }
                }
            </div>
        </div>
    </div>
</div>

@code {
    private TextStyle currentStyle = new TextStyle();
    private string articleText = @"Это пример текста статьи. Вы можете редактировать этот текст в поле выше.

Просто начните печатать, и вы увидите как текст будет отображаться с выбранными настройками стиля.

# Это заголовок H1
## Это заголовок H2

Вы можете использовать символ # для создания заголовков.";

    protected override void OnInitialized()
    {
        currentStyle = StyleService.CurrentStyle;
    }

    private int WordCount => string.IsNullOrEmpty(articleText) 
        ? 0 
        : articleText.Split(new[] { ' ', '\n', '\r', '\t' }, StringSplitOptions.RemoveEmptyEntries).Length;

    private string[] GetFormattedText()
    {
        return articleText.Split(new[] { "\r\n", "\r", "\n" }, StringSplitOptions.RemoveEmptyEntries);
    }

    private string GetPreviewStyle()
    {
        return $@"
            font-family: {currentStyle.PrimaryFont};
            font-size: {currentStyle.BodySize}pt;
            line-height: {currentStyle.BodyLineSpacing};
            column-count: {currentStyle.ColumnCount};
            column-gap: {currentStyle.ColumnGap}cm;
            background: white;
            padding: 30px;
            border-radius: 8px;
            min-height: 400px;
        ";
    }

    private string GetH1Style()
    {
        return $@"
            font-family: {currentStyle.HeadingFont};
            font-size: {currentStyle.H1Size}pt;
            line-height: {currentStyle.HeadingLineSpacing};
            color: #2c3e50;
            margin: 30px 0 20px 0;
        ";
    }

    private string GetH2Style()
    {
        return $@"
            font-family: {currentStyle.HeadingFont};
            font-size: {currentStyle.H2Size}pt;
            line-height: {currentStyle.HeadingLineSpacing};
            color: #34495e;
            margin: 25px 0 15px 0;
        ";
    }

    private string GetParagraphStyle()
    {
        return $@"
            font-family: {currentStyle.PrimaryFont};
            font-size: {currentStyle.BodySize}pt;
            line-height: {currentStyle.BodyLineSpacing};
            color: #2c3e50;
            margin: 15px 0;
            text-align: justify;
        ";
    }

    private void InsertHeading()
    {
        articleText += "\n# Новый заголовок\n";
    }

    private void ClearText()
    {
        articleText = string.Empty;
    }

    private void SaveSettings()
    {
        StyleService.UpdateStyle(currentStyle);
        // Здесь можно добавить сохранение текста в базу данных
    }

    private void ResetToDefault()
    {
        currentStyle = new TextStyle();
        StyleService.ResetToDefault();
    }
}