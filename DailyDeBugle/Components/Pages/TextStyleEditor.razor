@page "/text-style"
@rendermode InteractiveServer
@using DailyDeBugle.Models
@using DailyDebugle.Services
@inject StyleService StyleService

<PageTitle>Daily Debugle - Редактор текста</PageTitle>

<div class="text-style-container">
    <!-- Панель настроек -->
    <div class="settings-panel">
        <h3 class="panel-title">Типографика</h3>
        
        <!-- Шрифты -->
        <div class="setting-group">
            <h5>Шрифты:</h5>
            
            <div class="form-field">
                <label>Основной шрифт:</label>
                <select value="@currentStyle.PrimaryFont" @onchange="@(e => { currentStyle.PrimaryFont = e.Value?.ToString() ?? "Times New Roman"; StateHasChanged(); })" class="form-select">
                    <option value="Times New Roman">Times New Roman</option>
                    <option value="Arial">Arial</option>
                    <option value="Georgia">Georgia</option>
                    <option value="Verdana">Verdana</option>
                    <option value="Courier New">Courier New</option>
                    <option value="Helvetica">Helvetica</option>
                    <option value="Garamond">Garamond</option>
                </select>
            </div>
            
            <div class="form-field">
                <label>Заголовки:</label>
                <select value="@currentStyle.HeadingFont" @onchange="@(e => { currentStyle.HeadingFont = e.Value?.ToString() ?? "Times New Roman"; StateHasChanged(); })" class="form-select">
                    <option value="Times New Roman">Times New Roman</option>
                    <option value="Arial">Arial</option>
                    <option value="Georgia">Georgia</option>
                    <option value="Verdana">Verdana</option>
                    <option value="Courier New">Courier New</option>
                    <option value="Helvetica">Helvetica</option>
                    <option value="Garamond">Garamond</option>
                </select>
            </div>
        </div>

        <!-- Размеры текста -->
        <div class="setting-group">
            <h5>Размеры текста (pt):</h5>
            
            <div class="form-field">
                <label>Заголовок H1 (18-48pt):</label>
                <input type="number" value="@currentStyle.H1Size" 
                       @oninput="@(e => { if (int.TryParse(e.Value?.ToString(), out var val)) { currentStyle.H1Size = Clamp(val, 18, 48); StateHasChanged(); } })" 
                       class="form-control" />
            </div>
            
            <div class="form-field">
                <label>Заголовок H2 (16-36pt):</label>
                <input type="number" value="@currentStyle.H2Size" 
                       @oninput="@(e => { if (int.TryParse(e.Value?.ToString(), out var val)) { currentStyle.H2Size = Clamp(val, 16, 36); StateHasChanged(); } })" 
                       class="form-control" />
            </div>
            
            <div class="form-field">
                <label>Основной текст (12-18pt):</label>
                <input type="number" value="@currentStyle.BodySize" 
                       @oninput="@(e => { if (int.TryParse(e.Value?.ToString(), out var val)) { currentStyle.BodySize = Clamp(val, 12, 18); StateHasChanged(); } })" 
                       class="form-control" />
            </div>
        </div>

        <!-- Междустрочные интервалы -->
        <div class="setting-group">
            <h5>Междустрочные интервалы:</h5>
            
            <div class="form-field">
                <label>Основной текст (1.2-2.0):</label>
                <input type="number" value="@GetRoundedValue(currentStyle.BodyLineSpacing)" 
                       @oninput="@(e => HandleDecimalInput(e, false))" 
                       class="form-control" step="0.1" />
            </div>
            
            <div class="form-field">
                <label>Заголовки (1.0-1.8):</label>
                <input type="number" value="@GetRoundedValue(currentStyle.HeadingLineSpacing)" 
                       @oninput="@(e => HandleDecimalInput(e, true))" 
                       class="form-control" step="0.1" />
            </div>
        </div>

        <!-- Колонки -->
        <div class="setting-group">
            <h5>Колонки</h5>
            
            <div class="form-field">
                <label>Количество колонок:</label>
                <div class="column-buttons">
                    @foreach (var col in new[] { 1, 2, 3, 4 })
                    {
                        <button class="column-btn @(currentStyle.ColumnCount == col ? "active" : "")"
                                @onclick="() => ChangeColumnCount(col)">
                            @col
                        </button>
                    }
                </div>
            </div>
            
            <div class="form-field">
                <label>Расстояние между колонками (0.5-3.0см):</label>
                <input type="number" value="@GetRoundedValue(currentStyle.ColumnGap)" 
                       @oninput="@(e => HandleColumnGapInput(e))" 
                       class="form-control" step="0.1" />
            </div>
        </div>

        <!-- Кнопки управления -->
        <div class="action-buttons">
            <button class="btn btn-secondary" @onclick="ResetToDefault">
                Сбросить настройки
            </button>
            <button class="btn btn-primary" @onclick="SaveSettings">
                Сохранить стиль
            </button>
        </div>
    </div>

    <!-- Панель редактора и предпросмотра -->
    <div class="editor-preview-panel">
        <h4>Редактор текста</h4>
        
        <!-- Редактор текста -->
        <div class="text-editor">
            <div class="editor-toolbar">
                <button class="btn btn-sm btn-outline-secondary" @onclick="InsertHeading">
                    Добавить заголовок
                </button>
                <button class="btn btn-sm btn-outline-secondary" @onclick="ClearText">
                    Очистить
                </button>
            </div>
            
            <textarea @bind="articleText" class="form-control editor-textarea" 
                     placeholder="Начните писать ваш текст здесь..."></textarea>
            
            <div class="editor-info">
                <small>Символов: @articleText.Length | Слов: @WordCount</small>
            </div>
        </div>

        <!-- Предпросмотр -->
        <div class="preview-section">
            <h5>Предпросмотр (изменения видны сразу):</h5>
            
            <div class="current-settings">
                <small>Текущие настройки: 
                    Шрифт: @currentStyle.PrimaryFont, 
                    H1: @currentStyle.H1Size pt, 
                    H2: @currentStyle.H2Size pt,
                    Основной: @currentStyle.BodySize pt,
                    Интервал: @GetRoundedValue(currentStyle.BodyLineSpacing),
                    Колонки: @currentStyle.ColumnCount
                </small>
            </div>
            
            <div class="preview-content" style="@GetPreviewStyle()">
                @if (string.IsNullOrEmpty(articleText))
                {
                    <p style="color: #999; font-style: italic;">Текст для предпросмотра появится здесь...</p>
                }
                else
                {
                    @foreach (var paragraph in GetFormattedText())
                    {
                        if (paragraph.StartsWith("# "))
                        {
                            <h1 style="@GetH1Style()">@paragraph.Substring(2)</h1>
                        }
                        else if (paragraph.StartsWith("## "))
                        {
                            <h2 style="@GetH2Style()">@paragraph.Substring(3)</h2>
                        }
                        else
                        {
                            <p style="@GetParagraphStyle()">@paragraph</p>
                        }
                    }
                }
            </div>
        </div>
    </div>
</div>

@code {
    private TextStyle currentStyle = new TextStyle();
    private string articleText = @"Это пример текста статьи. Вы можете редактировать этот текст в поле выше.

Просто начните печатать, и вы увидите как текст будет отображаться с выбранными настройками стиля.

# Это заголовок H1
## Это заголовок H2

Вы можете использовать символ # для создания заголовков.";

    protected override void OnInitialized()
    {
        currentStyle = StyleService.CurrentStyle;
    }

    // Простая функция ограничения значений
    private int Clamp(int value, int min, int max)
    {
        if (value < min) return min;
        if (value > max) return max;
        return value;
    }

    private string GetRoundedValue(double value)
    {
        return Math.Round(value, 1).ToString("0.0", System.Globalization.CultureInfo.InvariantCulture);
    }

    private int WordCount => string.IsNullOrEmpty(articleText) 
        ? 0 
        : articleText.Split(new[] { ' ', '\n', '\r', '\t' }, StringSplitOptions.RemoveEmptyEntries).Length;

    private string[] GetFormattedText()
    {
        return articleText.Split(new[] { "\r\n", "\r", "\n" }, StringSplitOptions.RemoveEmptyEntries);
    }

    private string GetPreviewStyle()
    {
        return $@"
            font-family: {currentStyle.PrimaryFont};
            font-size: {currentStyle.BodySize}pt;
            line-height: {GetRoundedValue(currentStyle.BodyLineSpacing)};
            column-count: {currentStyle.ColumnCount};
            column-gap: {GetRoundedValue(currentStyle.ColumnGap)}cm;
            background: white;
            padding: 30px;
            border-radius: 8px;
            min-height: 400px;
        ";
    }

    private string GetH1Style()
    {
        return $@"
            font-family: {currentStyle.HeadingFont};
            font-size: {currentStyle.H1Size}pt;
            line-height: {GetRoundedValue(currentStyle.HeadingLineSpacing)};
            color: #2c3e50;
            margin: 30px 0 20px 0;
        ";
    }

    private string GetH2Style()
    {
        return $@"
            font-family: {currentStyle.HeadingFont};
            font-size: {currentStyle.H2Size}pt;
            line-height: {GetRoundedValue(currentStyle.HeadingLineSpacing)};
            color: #34495e;
            margin: 25px 0 15px 0;
        ";
    }

    private string GetParagraphStyle()
    {
        return $@"
            font-family: {currentStyle.PrimaryFont};
            font-size: {currentStyle.BodySize}pt;
            line-height: {GetRoundedValue(currentStyle.BodyLineSpacing)};
            color: #2c3e50;
            margin: 15px 0;
            text-align: justify;
        ";
    }

    private void HandleDecimalInput(ChangeEventArgs e, bool isHeading)
    {
        var input = e.Value?.ToString();
        if (double.TryParse(input, System.Globalization.NumberStyles.Any, System.Globalization.CultureInfo.InvariantCulture, out var val))
        {
            val = Math.Round(val, 1);
            
            // Авто-ограничение значений
            if (isHeading)
                currentStyle.HeadingLineSpacing = Math.Max(1.0, Math.Min(1.8, val));
            else
                currentStyle.BodyLineSpacing = Math.Max(1.2, Math.Min(2.0, val));
                
            StateHasChanged();
        }
    }

    private void HandleColumnGapInput(ChangeEventArgs e)
    {
        var input = e.Value?.ToString();
        if (double.TryParse(input, System.Globalization.NumberStyles.Any, System.Globalization.CultureInfo.InvariantCulture, out var val))
        {
            val = Math.Round(val, 1);
            // Авто-ограничение расстояния между колонками
            currentStyle.ColumnGap = Math.Max(0.5, Math.Min(3.0, val));
            StateHasChanged();
        }
    }

    private void ChangeColumnCount(int count)
    {
        currentStyle.ColumnCount = count;
        StateHasChanged();
    }

    private void InsertHeading()
    {
        articleText += "\n# Новый заголовок\n";
        StateHasChanged();
    }

    private void ClearText()
    {
        articleText = string.Empty;
        StateHasChanged();
    }

    private void SaveSettings()
    {
        StyleService.UpdateStyle(currentStyle);
    }

    private void ResetToDefault()
    {
        currentStyle = new TextStyle();
        StyleService.ResetToDefault();
        StateHasChanged();
    }
}